repositories {
    maven { url 'https://jitpack.io' }
}
configurations {
    zomboidDoc.extendsFrom zomboidRuntimeOnly
    zomboidDoc.extendsFrom zomboidImplementation
}
dependencies {
    // https://github.com/real-coco-labs/pz-zdoc
    zomboidDoc 'com.github.real-coco-labs:pz-zdoc:v2+'

    // ZomboidDoc compiled Lua library
    compileOnly files("lib/pz-zdoc-lua-$game_version" + '.jar')
}

def zomboidLuaJar = tasks.register('zomboidLuaJar', Jar.class) {
    it.description('Assembles a jar containing compiled lua classes.')
    it.setGroup('zomboid')

    it.archiveFileName = "pz-zdoc-lua-${game_version}.jar"
    it.destinationDir(file("$buildDir/libs"))
    it.from "$buildDir/generated/sources/zdoc/"
    it.into 'lib'
}
jar.dependsOn(zomboidLuaJar.get())

tasks.register('zomboidVersion', JavaExec.class) {
    it.description('Read Project Zomboid game version.')
    it.group('zomboid')

    it.main = 'io.yooksi.pz.zdoc.Main'
    it.classpath = configurations.zomboidDoc
    it.args 'version'

    OutputStream oStream = new ByteArrayOutputStream()
    it.setStandardOutput(oStream)

    it.doLast {
        // get application command output from stream
        // ex. game version 41.50 - IWBUMS
        def versionText = oStream.toString()

        // get version number and classifier (ex. 41.50-IWBUMS)
        project.ext.gameVersion = versionText.substring(18).replaceAll(" ", "")
        println("game version: ${project.ext.gameVersion}")
    }
}

tasks.register('annotateZomboidLua', JavaExec.class) {
    it.description('Annotate vanilla Lua with EmmyLua.')
    it.setGroup('zomboid')

    it.main = 'io.yooksi.pz.zdoc.Main'
    it.classpath = configurations.zomboidDoc
    it.args('annotate', '-i', "$gameDir/media/lua", '-o', "$buildDir/generated/sources/zdoc/media/lua")
}

tasks.register('compileZomboidLua', JavaExec.class) {
    it.description('Compile Lua library from modding API.')
    it.setGroup('zomboid')

    it.main = 'io.yooksi.pz.zdoc.Main'
    it.classpath = configurations.zomboidDoc
    it.args('compile', '-i', "$gameDir", '-o', "$buildDir/generated/sources/zdoc/media/lua/shared/Library")
}
